import { computed, onMounted, reactive, ref } from 'vue'
import useHttp from "@/composables/useHttp";
import <%= tableDetailCurrent.tableNameSingularUCamelCase %>Service from "@/modules/<%= pathModule %>/services/<%= tableDetailCurrent.tableNameSingularUCamelCase %>";
import type { Ref } from "vue";
import type { <%= tableDetailCurrent.tableNameSingularUCamelCase %> } from "../../types/<%= tableDetailCurrent.tableNameSingularUCamelCase %>";

export default (<%= tableMasterSingular; %>Id: string) => {
  /*const saleTypeOptions = [
    { label: 'Mayor', value: 0 },
    { label: 'Detal', value: 1 }  
  ]
  const statusOptions = [
    { label: 'Inactivo', value: 0 },
    { label: 'Activo', value: 1 }  
  ]*/
  
  const <%= tableDetailCurrent.tableNameSingular; %>: <%= tableDetailCurrent.tableNameSingularUCamelCase; %> = reactive({<%
  tableDetailCurrent.tableStructureOfDetails[0].filter(
      f => !['created_at', 'updated_at', 'deleted_at'].includes(f.column_name)
    ).forEach(function(field){ %>
    <%= field.column_name; %>: "", %><% }); %>
  })
  
  const <%= tableDetailCurrent.tableName %>: Ref<<%= tableDetailCurrent.tableNameSingularUCamelCase %>[]>  = ref([])
  const panelOpened = ref(false)
  const closeButtonOpened = computed(()=> panelOpened.value ? "Cerrar" : "Abrir")
  const closeClassOpened = computed(()=> panelOpened.value ? "btn-default" : "btn-primary")

  const {  
    errors,
    pending,

    getError
  } = useHttp()

  onMounted(() => get<%= tableDetailCurrent.tableNameUCamelCase %>())
  
  const get<%= tableDetailCurrent.tableNameUCamelCase %> = async () => {
    if (!<%= tableMasterSingular; %>Id)
      return null 
    pending.value = true
    <%= tableDetailCurrent.tableNameSingularUCamelCase %>Service.get<%= tableDetailCurrent.tableNameUCamelCase %>(<%= tableMasterSingular; %>Id)
      .then(res => <%= tableDetailCurrent.tableName %>.value = res.data)
      .catch(err => errors.value = getError(err))
      .finally(() => pending.value = false) 
  }

  const insert<%= tableDetailCurrent.tableNameSingularUCamelCase %> = async (payload: <%= tableDetailCurrent.tableNameSingularUCamelCase %>) => {
    pending.value = true
    payload.product_id = productId
    return <%= tableDetailCurrent.tableNameSingularUCamelCase %>Service.insert<%= tableDetailCurrent.tableNameSingularUCamelCase %>(payload)
      .then((response) => {
        panelOpened.value = false
        get<%= tableDetailCurrent.tableName %>()    
        alert( response.data.message )
              
      })
      .catch((err) => {                
        console.log( err.response.data )
        errors.value = getError(err)
      })
      .finally(() => {
        pending.value = false
      })
  }

  const update<%= tableDetailCurrent.tableNameSingularUCamelCase %> = async (payload: <%= tableDetailCurrent.tableNameSingularUCamelCase %>, <%= tableDetailCurrent.tableNameSingular %>Id: string) => {
    pending.value = true
    payload.product_id = productId
    payload._method = 'PUT'        
    return <%= tableDetailCurrent.tableNameSingularUCamelCase %>Service.update<%= tableDetailCurrent.tableNameSingularUCamelCase %>(payload, <%= tableDetailCurrent.tableNameSingular %>Id)
      .then((response) => {        
        panelOpened.value = false
        get<%= tableDetailCurrent.tableNameUCamelCase %>()    
        alert( response.data.message )     
      })
      .catch((err) => {                
        console.log( err.response.data )
        errors.value = getError(err)
      })
      .finally(() => {
        pending.value = false
      })
  }
  
  const submit = (payload: <%= tableDetailCurrent.tableNameSingularUCamelCase %>) => {    
    !<%= tableDetailCurrent.tableNameSingular %>.id ? insert<%= tableDetailCurrent.tableNameSingularUCamelCase %> (payload)  : update<%= tableDetailCurrent.tableNameSingularUCamelCase %>(payload, <%= tableDetailCurrent.tableNameSingular %>.id)
  }

  const edit = (<%= tableDetailCurrent.tableNameSingular %>Edit: <%= tableDetailCurrent.tableNameSingularUCamelCase %>) => {
    // presentation.status = presentationEdit.sale_type ? 1 : 0<%
  tableDetailCurrent.tableStructureOfDetails[0].filter(
      f => !['created_at', 'updated_at', 'deleted_at'].includes(f.column_name)
    ).forEach(function(field){ %>
    <%= tableDetailCurrent.tableNameSingular; %>.<%= field.column_name; %> = <%= tableDetailCurrent.tableNameSingular %>Edit.<%= field.column_name; %>%><% }); %>
    panelOpened.value = true
  }
  
  const remove = async (<%= tableDetailCurrent.tableNameSingular %>Id: string) => {
    if (<%= tableDetailCurrent.tableNameSingular %>Id === undefined)
      return
    else if (confirm(`¿Estás seguro que desea eliminar el registro ${<%= tableDetailCurrent.tableNameSingular %>Id}?`)) {  
      pending.value = true    
      return <%= tableDetailCurrent.tableNameSingularUCamelCase %>Service.delete<%= tableDetailCurrent.tableNameSingularUCamelCase %>(<%= tableDetailCurrent.tableNameSingular %>Id)
        .then((response) => {        
          get<%= tableDetailCurrent.tableNameUCamelCase %>()
        })
        .catch((err) => {                
          console.log( err.response.data )
          errors.value = getError(err)
        })
        .finally(() => {
          pending.value = false
        })
    }
  }

  return {
    panelOpened,
    closeButtonOpened,
    closeClassOpened,
    <%= tableDetailCurrent.tableName %>,
    <%= tableDetailCurrent.tableNameSingular %>,
    /*saleTypeOptions,
    statusOptions,*/

    edit,
    get<%= tableDetailCurrent.tableNameUCamelCase %>,
    remove, 
    submit
  }
}
